<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bot Agent - 你的AI伙伴</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@300;400;500;600;700&family=Varela+Round&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/styles/chat.css">

    <!-- API 客户端脚本 -->
    <script src="assets/lib/api-client.js"></script>
    <script src="assets/lib/auth-manager.js"></script>
    <script src="assets/lib/bot-client.js"></script>
</head>
<body>
    <!-- 呼吸光环背景 -->
    <div class="breathing-glow"></div>

    <div class="container">
        <!-- 左侧导航 -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="logo">Bot Agent</div>
                <div class="subtitle">你的AI伙伴，随时陪聊</div>
                <button id="logoutBtn" class="logout-btn" title="登出">➔</button>
            </div>

            <!-- Tab切换 -->
            <div class="tab-switcher">
                <button class="tab-btn active" data-tab="scenes">单Bot</button>
                <button class="tab-btn" data-tab="groups">群聊</button>
            </div>

            <!-- 单Bot：Folder + 话题列表 -->
            <div class="list-container single-bot-list-container" id="scenesList">
                <div class="folder-chip-section">
                    <div class="folder-chip-divider"></div>
                    <div class="folder-chip-row" id="folderChipRow">
                        <button class="folder-chip active" data-chip-id="all" type="button">全部12</button>
                        <button class="folder-chip" data-chip-id="work" type="button">工作5</button>
                        <button class="folder-chip" data-chip-id="mentor" type="button">职场导师3</button>
                        <button class="folder-chip" data-chip-id="life" type="button">生活1</button>
                        <button class="folder-chip add" id="folderChipAddBtn" type="button">+</button>
                    </div>
                </div>

                <div class="topic-list-section">
                    <div class="topic-list-header">
                        <div class="topic-list-title" id="topicListTitle">职场导师 的话题</div>
                    </div>
                    <div class="topic-list-divider"></div>
                    <div class="topic-conversation-list" id="topicConversationList">
                        <div class="folder-topic-empty">加载话题中...</div>
                    </div>
                </div>

                <!-- 旧分组结构保留为隐藏挂载点，避免影响现有群聊/脚本流程 -->
                <div class="legacy-scene-groups" aria-hidden="true">
                    <div class="bot-group" id="workBotGroup"><div class="bot-group-header"><div class="bot-group-avatar">💼</div><div class="bot-group-info"><div class="bot-group-name">工作</div><div class="bot-group-meta">工作场景</div></div><div class="bot-group-collapse">▼</div></div><div class="bot-group-content"><div class="conversation-list"></div></div></div>
                    <div class="bot-group" id="lifeBotGroup"><div class="bot-group-header"><div class="bot-group-avatar">🌿</div><div class="bot-group-info"><div class="bot-group-name">生活</div><div class="bot-group-meta">生活场景</div></div><div class="bot-group-collapse">▼</div></div><div class="bot-group-content"><div class="conversation-list"></div></div></div>
                    <div class="bot-group" id="loveBotGroup"><div class="bot-group-header"><div class="bot-group-avatar">💜</div><div class="bot-group-info"><div class="bot-group-name">情感</div><div class="bot-group-meta">情感场景</div></div><div class="bot-group-collapse">▼</div></div><div class="bot-group-content"><div class="conversation-list"></div></div></div>
                </div>
            </div>

            <!-- 群聊列表（默认隐藏） -->
            <div class="list-container" id="groupsList" style="display: none;">
                <div class="group-card" data-type="group" data-id="group1">
                    <div class="card-header">
                        <span class="card-icon">🎯</span>
                        <div class="card-info">
                            <div class="card-name">创业顾问团</div>
                            <div class="card-desc">CEO + CTO + CMO</div>
                        </div>
                    </div>
                    <div class="group-members">
                        <div class="member-avatar" style="background: linear-gradient(135deg, #E8E4FF 0%, #F0ECFF 100%);">💼</div>
                        <div class="member-avatar" style="background: linear-gradient(135deg, #E8FFE8 0%, #F0FFF0 100%);">💻</div>
                        <div class="member-avatar" style="background: linear-gradient(135deg, #FFE8EC 0%, #FFF0F3 100%);">📈</div>
                        <span class="member-count">3个成员</span>
                    </div>
                </div>

                <div class="group-card" data-type="group" data-id="group2">
                    <div class="card-header">
                        <span class="card-icon">💪</span>
                        <div class="card-info">
                            <div class="card-name">成长加速器</div>
                            <div class="card-desc">工作 + 学习 + 健康</div>
                        </div>
                    </div>
                    <div class="group-members">
                        <div class="member-avatar" style="background: linear-gradient(135deg, #E8E4FF 0%, #F0ECFF 100%);">💼</div>
                        <div class="member-avatar" style="background: linear-gradient(135deg, #E8FFE8 0%, #F0FFF0 100%);">📚</div>
                        <div class="member-avatar" style="background: linear-gradient(135deg, #FFE8EC 0%, #FFF0F3 100%);">🏃</div>
                        <span class="member-count">3个成员</span>
                    </div>
                </div>

                <button class="create-btn">
                    <span>✨</span>
                    <span>邀请更多朋友一起聊聊</span>
                </button>
            </div>

            <div class="sidebar-footer" id="sidebarFooter">
                <div class="sidebar-footer-divider"></div>
                <div class="sidebar-footer-actions">
                    <button class="sidebar-footer-primary" id="topicCreateBtn" type="button">+ 新建话题</button>
                    <button class="sidebar-footer-icon" id="trashToggleBtn" type="button" title="回收站">🗑️</button>
                </div>
            </div>
        </div>

        <!-- 聊天区域 -->
        <div class="chat-area">
            <div class="chat-header">
                <div class="chat-info">
                    <div class="chat-avatar work" id="chatAvatar">🤖</div>
                    <div class="chat-details">
                        <h2 id="chatName">加载中...</h2>
                        <p id="chatStatus">连接中...</p>
                        <div class="group-members-header" id="groupMembersHeader" style="display: none;">
                            <!-- 群聊时动态添加成员头像 -->
                        </div>
                    </div>
                </div>
                <div class="chat-actions">
                    <button class="action-btn primary" id="sopBtn">⏰ 提醒</button>
                    <button class="action-btn" id="logBtn">📋</button>
                    <button class="action-btn" id="quickSettingsBtn">⚙️</button>
                </div>
            </div>

            <!-- Tab导航系统 -->
            <div class="content-tabs">
                <button class="content-tab-btn active" data-tab="chat">💬 对话</button>
                <button class="content-tab-btn" data-tab="memory">🧠 记忆</button>
                <button class="content-tab-btn" data-tab="knowledge">📚 知识库</button>
                <button class="content-tab-btn" data-tab="settings">⚙️ 设置</button>
            </div>

            <!-- 对话内容面板 -->
            <div class="content-panel active" id="chatPanel">
                <div class="chat-messages" id="messages">
                    <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                        加载对话中...
                    </div>
                </div>
            </div>

            <div class="chat-input">
                <div class="chat-input-toolbar">
                    <button class="composer-tool-btn" id="uploadToolBtn" type="button">📎 上传</button>
                    <button class="composer-tool-btn" id="recordToolBtn" type="button">🎙️ 录音</button>
                    <button class="composer-tool-btn" id="injectMemoryBtn" type="button">🧠 注入记忆</button>
                    <button class="composer-tool-btn muted" id="composerMoreBtn" type="button">···</button>
                    <button class="composer-tool-btn archive" id="archiveConversationBtn" type="button">🗂️ 归档此次对话</button>
                    <input type="file" id="chatUploadInput" hidden />
                </div>
                <button class="mention-btn" id="mentionBtn" title="@提及Bot" style="display: none;">@</button>
                <div class="input-wrapper">
                    <textarea id="input" placeholder="今天想聊点什么呢？我随时都在 💜"></textarea>
                </div>
                <button class="send-btn" id="sendBtn">发送 ✨</button>
            </div>

            <!-- 记忆内容面板 -->
            <div class="content-panel" id="memoryPanel">
                <div class="memory-container">
                    <div class="memory-section-card">
                        <div class="memory-section-title">
                            <span>📌</span>
                            <span>关键要点</span>
                        </div>
                        <div class="key-points-list" id="keyPointsList">
                            <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                                暂无关键要点
                            </div>
                        </div>
                    </div>

                    <div class="memory-section-card">
                        <div class="memory-section-title">
                            <span>📝</span>
                            <span>上下文记忆</span>
                        </div>
                        <div class="context-memory-list" id="contextMemoryList">
                            <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                                暂无上下文记忆
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 知识库内容面板 -->
            <div class="content-panel" id="knowledgePanel">
                <div class="knowledge-container">
                    <div class="upload-zone" id="uploadZone">
                        <div class="upload-zone-icon">📤</div>
                        <div class="upload-zone-title">点击上传文件</div>
                        <div class="upload-zone-desc">支持 PDF, Word, Excel, TXT 等格式</div>
                    </div>

                    <div class="file-list" id="fileList">
                        <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                            暂无知识库文件
                        </div>
                    </div>
                </div>
            </div>

            <!-- 设置内容面板 -->
            <div class="content-panel" id="settingsPanel">
                <div class="settings-container">
                    <div class="settings-section">
                        <div class="settings-section-header">
                            <div class="settings-section-title">
                                <span>⚙️</span>
                                <span>系统提示词</span>
                            </div>
                            <button class="edit-prompt-btn" id="editPromptBtn">✏️ 编辑</button>
                        </div>
                        <div class="prompt-display" id="promptDisplay">
                            加载中...
                        </div>
                        <div id="promptEditorContainer" style="display: none;">
                            <textarea class="prompt-editor" id="promptEditor"></textarea>
                            <button class="save-prompt-btn" id="savePromptBtn">保存提示词</button>
                        </div>
                    </div>

                    <div class="settings-section">
                        <div class="settings-section-header">
                            <div class="settings-section-title">
                                <span>🤖</span>
                                <span>AI 模型配置</span>
                            </div>
                        </div>
                        <div class="settings-field">
                            <label class="settings-label">模型</label>
                            <select class="settings-select" id="modelSelect">
                                <option value="deepseek-ai/DeepSeek-V3.2">DeepSeek V3.2（推荐）</option>
                                <option value="deepseek-ai/DeepSeek-R1">DeepSeek R1（推理）</option>
                                <option value="Qwen/Qwen2.5-72B-Instruct">Qwen2.5-72B</option>
                            </select>
                        </div>
                        <div class="settings-field">
                            <label class="settings-label">温度（0-2）</label>
                            <input class="settings-input" id="temperatureInput" type="number" min="0" max="2" step="0.1" value="0.7" />
                            <div class="settings-hint">越高越随机，建议0.7-1.0</div>
                        </div>
                        <div class="settings-field">
                            <label class="settings-label">最大 Token 数</label>
                            <input class="settings-input" id="maxTokensInput" type="number" min="100" max="8000" step="100" value="2000" />
                            <div class="settings-hint">控制回复长度</div>
                        </div>
                        <button class="save-config-btn" id="saveConfigBtn">💾 保存配置</button>
                    </div>
                </div>
            </div>

            <aside class="right-side-panel" id="rightSidePanel" aria-hidden="true">
                <div class="right-panel-header">
                    <div class="right-panel-title" id="rightPanelTitle">归档预览</div>
                    <button class="right-panel-close" id="rightPanelCloseBtn" type="button" aria-label="关闭">✕</button>
                </div>
                <div class="right-panel-divider"></div>

                <div class="right-panel-body active" id="archivePreviewPanel">
                    <div class="panel-form-row">
                        <label for="archiveTopicTitleInput">话题标题</label>
                        <input id="archiveTopicTitleInput" type="text" />
                    </div>
                    <div class="panel-form-row">
                        <label for="archiveSummaryInput">AI摘要</label>
                        <textarea id="archiveSummaryInput" rows="4"></textarea>
                    </div>
                    <div class="panel-form-row">
                        <label for="archiveInsightInput">关键洞察</label>
                        <textarea id="archiveInsightInput" rows="5"></textarea>
                    </div>
                    <div class="panel-form-row">
                        <label>归档时间</label>
                        <div class="panel-static-text" id="archiveMetaText">第2次 · 2026/2/22</div>
                    </div>
                    <div class="panel-form-row">
                        <label>标签</label>
                        <div class="tag-chip-list" id="archiveTagList">
                            <button class="tag-chip active" type="button">薪资谈判</button>
                            <button class="tag-chip" type="button">职场策略</button>
                            <button class="tag-chip" type="button">沟通复盘</button>
                        </div>
                    </div>
                    <div class="right-panel-footer">
                        <button class="panel-btn secondary" id="archiveCancelBtn" type="button">取消</button>
                        <button class="panel-btn primary" id="archiveConfirmBtn" type="button">✓ 确认存入记忆</button>
                    </div>
                </div>

                <div class="right-panel-body" id="memoryPickerPanel">
                    <div class="memory-picker-list" id="memoryPickerList">
                        <label class="memory-picker-item">
                            <input type="checkbox" value="m1" />
                            <div class="memory-picker-content">
                                <div class="memory-picker-title">薪资谈判·第1次 <span>2026/1/10</span></div>
                                <div class="memory-picker-quote">"用贡献-市场-期望三段式..."</div>
                            </div>
                        </label>
                        <label class="memory-picker-item">
                            <input type="checkbox" value="m2" />
                            <div class="memory-picker-content">
                                <div class="memory-picker-title">薪资谈判·第2次 <span>2026/2/1</span></div>
                                <div class="memory-picker-quote">"实战后复盘，老板反应..."</div>
                            </div>
                        </label>
                        <label class="memory-picker-item">
                            <input type="checkbox" value="m3" />
                            <div class="memory-picker-content">
                                <div class="memory-picker-title">跨部门协作·复盘 <span>2026/1/20</span></div>
                                <div class="memory-picker-quote">"推动协作需要提前..."</div>
                            </div>
                        </label>
                    </div>
                    <div class="right-panel-footer compact">
                        <div class="memory-picked-count" id="memoryPickedCount">已选0条</div>
                        <button class="panel-btn primary" id="memoryInjectConfirmBtn" type="button">注入本次对话</button>
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <div id="topicFolderModal" class="topic-folder-modal-mask" aria-hidden="true">
        <div class="topic-folder-modal-card" role="dialog" aria-modal="true" aria-labelledby="topicFolderModalTitle">
            <div class="topic-folder-modal-header">
                <div>
                    <div class="topic-folder-modal-title" id="topicFolderModalTitle">新建话题</div>
                    <div class="topic-folder-modal-subtitle" id="topicFolderModalSceneSubtitle">在「职场导师」场景下创建</div>
                </div>
                <button type="button" class="topic-folder-close-btn" id="topicFolderCloseBtn" aria-label="关闭">×</button>
            </div>
            <div class="topic-folder-modal-body topic-create-upgraded-body">
                <div class="panel-form-row">
                    <label class="topic-folder-label" for="topicFolderNameInput">对话名称</label>
                    <input id="topicFolderNameInput" class="topic-folder-input" type="text" maxlength="50" placeholder="可留空（将自动生成）" />
                </div>

                <div class="panel-form-row">
                    <label class="topic-folder-label" for="topicExtraContextInput">补充背景</label>
                    <textarea id="topicExtraContextInput" class="topic-folder-textarea" rows="4" placeholder="可选。补充这次对话的背景、目标、约束、对象信息。仅在首条消息时注入提示词，例如：这次要帮我准备周一和老板的绩效沟通，目标是争取更多资源。"></textarea>
                </div>

                <div class="panel-form-row">
                    <label class="topic-folder-label" for="topicSystemPromptPreview">已加载系统提示词</label>
                    <textarea id="topicSystemPromptPreview" class="topic-folder-textarea" rows="5"></textarea>
                </div>

                <div class="panel-form-row">
                    <label class="topic-folder-label">预选记忆（可选）</label>
                    <div class="topic-memory-preset-list" id="topicMemoryPresetList">
                        <label class="topic-memory-preset-item"><input type="checkbox" value="m2" /> <span>薪资谈判·第2次</span></label>
                        <label class="topic-memory-preset-item"><input type="checkbox" value="m3" /> <span>跨部门协作·复盘</span></label>
                    </div>
                </div>
            </div>
            <div class="topic-folder-modal-footer">
                <button type="button" class="topic-folder-secondary-btn" id="topicFolderCancelBtn">取消</button>
                <button type="button" class="topic-folder-primary-btn" id="topicFolderCreateBtn">开始对话 →</button>
            </div>
        </div>
    </div>

    <div id="themeCreateModal" class="topic-folder-modal-mask" aria-hidden="true">
        <div class="topic-folder-modal-card" role="dialog" aria-modal="true" aria-labelledby="themeCreateModalTitle">
            <div class="topic-folder-modal-header">
                <div>
                    <div class="topic-folder-modal-title" id="themeCreateModalTitle">新建主题</div>
                    <div class="topic-folder-modal-subtitle" id="themeCreateModalSceneSubtitle">将在当前场景下创建助手主题</div>
                </div>
                <button type="button" class="topic-folder-close-btn" id="themeCreateCloseBtn" aria-label="关闭">×</button>
            </div>
            <div class="topic-folder-modal-body topic-create-upgraded-body">
                <div class="panel-form-row">
                    <label class="topic-folder-label" for="themeCreateNameInput">主题名称</label>
                    <input id="themeCreateNameInput" class="topic-folder-input" type="text" maxlength="50" placeholder="例如：职场导师" />
                </div>

                <div class="panel-form-row">
                    <label class="topic-folder-label" for="themeCreatePromptInput">系统提示词</label>
                    <textarea id="themeCreatePromptInput" class="topic-folder-textarea" rows="5" placeholder="例如：你是一位经验丰富的职场导师，擅长职业规划、晋升策略、沟通谈判。请用中文回答，结论先行，并给出可执行步骤。"></textarea>
                </div>

                <div class="panel-form-row">
                    <label class="topic-folder-label" for="themeCreateModelSelect">模型选择</label>
                    <select id="themeCreateModelSelect" class="topic-folder-input">
                        <option value="deepseek-ai/DeepSeek-V3.2">DeepSeek V3.2（推荐）</option>
                        <option value="deepseek-ai/DeepSeek-R1">DeepSeek R1（推理）</option>
                        <option value="Qwen/Qwen2.5-72B-Instruct">Qwen2.5-72B</option>
                    </select>
                </div>
            </div>
            <div class="topic-folder-modal-footer">
                <button type="button" class="topic-folder-secondary-btn" id="themeCreateCancelBtn">取消</button>
                <button type="button" class="topic-folder-primary-btn" id="themeCreateConfirmBtn">创建主题</button>
            </div>
        </div>
    </div>

    <div id="trashModal" class="trash-modal-mask" aria-hidden="true">
        <div class="trash-modal-card" role="dialog" aria-modal="true" aria-labelledby="trashModalTitle">
            <div class="trash-modal-header">
                <div>
                    <div class="trash-modal-title" id="trashModalTitle">会话回收站</div>
                    <div class="trash-modal-subtitle">可恢复已删除的话题，也可彻底删除</div>
                </div>
                <div class="trash-modal-actions">
                    <button type="button" class="trash-header-btn" id="trashRefreshBtn">刷新</button>
                    <button type="button" class="trash-header-btn" id="trashCloseBtn">关闭</button>
                </div>
            </div>
            <div class="trash-modal-list" id="trashList">
                <div class="trash-empty">加载中...</div>
            </div>
        </div>
    </div>

    <script src="assets/scripts/chat.js?v=20260222"></script>
</body>
</html>
